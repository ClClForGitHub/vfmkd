# æ¸è¿›å¼è¾¹ç¼˜æ©ç è®­ç»ƒç­–ç•¥

## ğŸ¯ è®¾è®¡æ€æƒ³

åœ¨64Ã—64çš„ä½åˆ†è¾¨ç‡ç‰¹å¾å›¾ä¸Šè¿›è¡Œè¾¹ç¼˜è’¸é¦æ—¶ï¼Œå­¦ç”Ÿæ¨¡å‹çš„å·ç§¯ç½‘ç»œä¼šåœ¨ç‰©ä½“å†…éƒ¨äº§ç”Ÿå¤§é‡ç»†ç¢çš„çº¹ç†è¾¹ç¼˜ã€‚è¿™äº›å†…éƒ¨çº¹ç†ä¼šå¹²æ‰°è¾¹ç¼˜æŸå¤±çš„è®¡ç®—ï¼Œå¯¼è‡´æ¨¡å‹éš¾ä»¥èšç„¦äºçœŸæ­£çš„ç‰©ä½“è½®å»“ã€‚

**æ¸è¿›å¼è¾¹ç¼˜æ©ç ï¼ˆProgressive Edge Maskï¼‰** ç­–ç•¥é€šè¿‡ä¸¤é˜¶æ®µè®­ç»ƒè§£å†³è¿™ä¸ªé—®é¢˜ï¼š

### ğŸ“Š ä¸¤é˜¶æ®µè®­ç»ƒæµç¨‹

```
ç¬¬1-5ä¸ªepochï¼ˆå…¨å±€å­¦ä¹ é˜¶æ®µï¼‰
â”œâ”€ å…³é—­è¾¹ç¼˜æ©ç 
â”œâ”€ åœ¨æ•´ä¸ª256Ã—256åŒºåŸŸè®¡ç®—BCE+DiceæŸå¤±
â””â”€ ç›®æ ‡ï¼šè®©æ¨¡å‹å…ˆå­¦ä¼š"åœ¨å“ªé‡Œæœ‰è¾¹ç¼˜"ï¼ˆç²—å®šä½ï¼‰

ç¬¬6-Nä¸ªepochï¼ˆç²¾ç¡®å¯¹é½é˜¶æ®µï¼‰
â”œâ”€ å¯ç”¨è¾¹ç¼˜æ©ç ï¼ˆ3Ã—3æ ¸è†¨èƒ€ï¼ŒÂ±1åƒç´ å®¹é”™åŒºï¼‰
â”œâ”€ åªåœ¨è†¨èƒ€åçš„è¾¹ç¼˜åŒºåŸŸå†…è®¡ç®—æŸå¤±
â””â”€ ç›®æ ‡ï¼šè®©æ¨¡å‹ä¸“æ³¨äº"è¾¹ç¼˜çš„ç²¾ç¡®ä½ç½®"ï¼ˆç»†å¯¹é½ï¼‰
     åŒæ—¶å¿½ç•¥ç‰©ä½“å†…éƒ¨çš„ç»†ç¢çº¹ç†
```

## ğŸ”¬ æŠ€æœ¯å®ç°

### 1. è¾¹ç¼˜è†¨èƒ€ï¼ˆEdge Dilationï¼‰

ä½¿ç”¨ **MaxPool2d** å®ç°é«˜æ•ˆçš„è¾¹ç¼˜è†¨èƒ€ï¼ˆç­‰ä»·äºå½¢æ€å­¦è†¨èƒ€ï¼‰ï¼š

```python
# 3Ã—3æ ¸ï¼Œstride=1ï¼Œpadding=1
# å¯¹äºŒå€¼å›¾ï¼ˆ0/1ï¼‰è¿›è¡Œæœ€å¤§æ± åŒ– = è†¨èƒ€æ“ä½œ
dilater = nn.MaxPool2d(kernel_size=3, stride=1, padding=1)
edge_mask = dilater(teacher_target)  # è¾¹ç¼˜å‘å¤–æ‰©å±•1ä¸ªåƒç´ 
```

**ä¸ºä»€ä¹ˆé€‰æ‹©3Ã—3æ ¸ï¼ˆÂ±1åƒç´ ï¼‰ï¼Ÿ**

- âœ… **å®¹å¿å¯¹é½è¯¯å·®**ï¼šåœ¨64Ã—64åˆ†è¾¨ç‡ä¸‹ï¼ŒÂ±1åƒç´ çš„åç§»æ˜¯æ­£å¸¸çš„
- âœ… **ç²¾ç¡®å¿½ç•¥å†…éƒ¨**ï¼šè¿œç¦»è½®å»“çš„å†…éƒ¨çº¹ç†ä»è¢«æ©ç æ’é™¤ï¼ˆå€¼ä¸º0ï¼‰
- âœ… **ç´§å‡‘é«˜æ•ˆ**ï¼šä¸ä¼šåƒ5Ã—5æˆ–7Ã—7é‚£æ ·è¿‡åº¦è†¨èƒ€

### 2. æ©ç BCEæŸå¤±

```python
# åŸå§‹BCEæŸå¤±ï¼ˆé€åƒç´ ï¼‰
bce_loss_per_pixel = BCEWithLogitsLoss(reduction='none')(pred, target)  # [B, H, W]

# åº”ç”¨è¾¹ç¼˜æ©ç 
bce_loss_masked = bce_loss_per_pixel * edge_mask  # åªä¿ç•™è¾¹ç¼˜åŒºåŸŸçš„æŸå¤±

# å½’ä¸€åŒ–ï¼ˆé™¤ä»¥æœ‰æ•ˆåƒç´ æ•°ï¼‰
num_valid = edge_mask.sum(dim=(1,2)).clamp(min=1.0)
bce_loss = (bce_loss_masked.sum(dim=(1,2)) / num_valid).mean()
```

### 3. æ©ç DiceæŸå¤±

```python
# åœ¨æ©ç åŒºåŸŸå†…è®¡ç®—Diceç³»æ•°
pred_masked = sigmoid(pred) * edge_mask
target_masked = target * edge_mask

intersection = (pred_masked * target_masked).sum()
union = pred_masked.sum() + target_masked.sum()

dice = (2 * intersection + smooth) / (union + smooth)
dice_loss = 1 - dice
```

## ğŸ“‹ ä½¿ç”¨æ–¹æ³•

### å‘½ä»¤è¡Œå‚æ•°

```bash
python tools/train_distill_single_test.py \
  --features-dir VFMKD/outputs/features_sam2_300 \
  --images-dir VFMKD/datasets/sa1b_subset_300 \
  --loss-type fgd \
  --backbone repvit \
  --epochs 20 \
  --batch-size 4 \
  --lr 1e-3 \
  --enable-edge-mask-progressive \       # å¯ç”¨æ¸è¿›å¼è¾¹ç¼˜æ©ç 
  --edge-mask-start-epoch 5 \            # ä»ç¬¬5ä¸ªepochå¼€å§‹
  --edge-mask-kernel-size 3              # 3Ã—3æ ¸ï¼ˆè†¨èƒ€1åƒç´ ï¼‰
```

### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--enable-edge-mask-progressive` | False | å¯ç”¨æ¸è¿›å¼è¾¹ç¼˜æ©ç  |
| `--edge-mask-start-epoch` | 5 | ä»ç¬¬å‡ ä¸ªepochå¼€å§‹å¯ç”¨æ©ç  |
| `--edge-mask-kernel-size` | 3 | è†¨èƒ€æ ¸å¤§å°ï¼ˆ3=Â±1åƒç´ ï¼Œ5=Â±2åƒç´ ï¼‰ |

## ğŸ“Š è®­ç»ƒæ—¥å¿—ç¤ºä¾‹

```
Epoch 1-4: Train total=0.4523 feat=0.3812 edge=0.0711
[å…¨å±€å­¦ä¹ é˜¶æ®µï¼Œæ— è¾¹ç¼˜æ©ç ]

============================================================
ğŸ¯ [Epoch 5] å¯ç”¨è¾¹ç¼˜åŒºåŸŸæ©ç ï¼
   ä»ç°åœ¨å¼€å§‹ï¼ŒæŸå¤±åªåœ¨è†¨èƒ€åçš„è¾¹ç¼˜åŒºåŸŸï¼ˆ3x3æ ¸ï¼ŒÂ±1åƒç´ ï¼‰å†…è®¡ç®—
   è¿™å°†å¿½ç•¥ç‰©ä½“å†…éƒ¨çš„ç»†ç¢çº¹ç†ï¼Œä¸“æ³¨äºç²¾ç¡®è¾¹ç¼˜å¯¹é½
============================================================

Epoch 5: Train total=0.3891 feat=0.3205 edge=0.0686
ğŸ“Š Edge Mask Coverage: 12.34% (avg across 67 batches)
   (è¾¹ç¼˜æ©ç è¦†ç›–äº† 12.34% çš„åƒç´ åŒºåŸŸ)

Epoch 6-20: ...
[ç²¾ç¡®å¯¹é½é˜¶æ®µï¼Œåªåœ¨è¾¹ç¼˜åŒºåŸŸè®¡ç®—æŸå¤±]
```

## ğŸ” é¢„æœŸæ•ˆæœ

### è®­ç»ƒå‰5ä¸ªepoch

- **å­¦ç”Ÿæ¨¡å‹è¡Œä¸º**ï¼šåœ¨æ•´ä¸ªå›¾åƒä¸Šäº§ç”Ÿè¾¹ç¼˜é¢„æµ‹
- **æŸå¤±è®¡ç®—èŒƒå›´**ï¼šå…¨å±€256Ã—256åŒºåŸŸ
- **å­¦ä¹ ç›®æ ‡**ï¼šç²—ç•¥å®šä½ç‰©ä½“è¾¹ç¼˜çš„å¤§è‡´ä½ç½®

### è®­ç»ƒç¬¬6ä¸ªepochå¼€å§‹

- **å­¦ç”Ÿæ¨¡å‹è¡Œä¸º**ï¼šä¸“æ³¨äºGTè¾¹ç¼˜é™„è¿‘çš„ç²¾ç¡®é¢„æµ‹
- **æŸå¤±è®¡ç®—èŒƒå›´**ï¼šä»…è†¨èƒ€åçš„è¾¹ç¼˜åŒºåŸŸï¼ˆ~10-15%åƒç´ ï¼‰
- **å­¦ä¹ ç›®æ ‡**ï¼šç²¾ç¡®å¯¹é½è¾¹ç¼˜ä½ç½®ï¼Œå¿½ç•¥å†…éƒ¨çº¹ç†å¹²æ‰°

### æœ€ç»ˆç»“æœ

- âœ… **è¾¹ç¼˜ç²¾åº¦æå‡**ï¼šå­¦ç”Ÿé¢„æµ‹æ›´æ¥è¿‘GTè½®å»“
- âœ… **å†…éƒ¨çº¹ç†æŠ‘åˆ¶**ï¼šå‡å°‘ç‰©ä½“å†…éƒ¨çš„è™šå‡è¾¹ç¼˜
- âœ… **æ”¶æ•›é€Ÿåº¦åŠ å¿«**ï¼šæ¨¡å‹ä¸å†è¢«å†…éƒ¨çº¹ç†è¯¯å¯¼

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§

### 1. å¯è§†åŒ–è¾¹ç¼˜æ©ç 

åœ¨è®­ç»ƒè„šæœ¬ä¸­æ·»åŠ å¯è§†åŒ–ä»£ç ï¼š

```python
import matplotlib.pyplot as plt

# åœ¨train_epochä¸­
if batch_idx == 0 and epoch == edge_mask_start_epoch:
    # å¯è§†åŒ–ç¬¬ä¸€ä¸ªbatchçš„è¾¹ç¼˜æ©ç 
    edge_mask_vis = edge_mask[0].cpu().numpy()  # [H, W]
    plt.imshow(edge_mask_vis, cmap='gray')
    plt.title(f"Edge Mask (Epoch {epoch})")
    plt.savefig(f"outputs/edge_mask_epoch{epoch}.png")
    plt.close()
```

### 2. ç›‘æ§æ©ç è¦†ç›–ç‡

è®­ç»ƒæ—¥å¿—ä¼šè‡ªåŠ¨æ‰“å°ï¼š

```
ğŸ“Š Edge Mask Coverage: 12.34%
```

- å¦‚æœ < 5%ï¼šæ©ç å¤ªå°ï¼Œè€ƒè™‘å¢å¤§kernel_sizeï¼ˆå¦‚5ï¼‰
- å¦‚æœ > 30%ï¼šæ©ç å¤ªå¤§ï¼Œè€ƒè™‘å‡å°kernel_sizeï¼ˆä¿æŒ3ï¼‰
- ç†æƒ³èŒƒå›´ï¼š10-20%ï¼ˆå–å†³äºç‰©ä½“å¤§å°å’Œå¤æ‚åº¦ï¼‰

### 3. å¯¹æ¯”å®éªŒ

å»ºè®®è¿›è¡Œä¸‰ç»„å¯¹æ¯”å®éªŒï¼š

```bash
# Aç»„ï¼šæ— è¾¹ç¼˜æ©ç ï¼ˆåŸºçº¿ï¼‰
python tools/train_distill_single_test.py ... 

# Bç»„ï¼šæ¸è¿›å¼è¾¹ç¼˜æ©ç ï¼ˆæ¨èï¼‰
python tools/train_distill_single_test.py ... --enable-edge-mask-progressive

# Cç»„ï¼šä»å¤´å¯ç”¨è¾¹ç¼˜æ©ç 
python tools/train_distill_single_test.py ... \
  --enable-edge-mask-progressive \
  --edge-mask-start-epoch 1  # ä»ç¬¬1ä¸ªepochå°±å¯ç”¨
```

é¢„æœŸç»“æœï¼š**Bç»„ > Aç»„ > Cç»„**

## ğŸ’¡ æœ€ä½³å®è·µ

1. **epochåˆ’åˆ†**ï¼š
   - å°æ•°æ®é›†ï¼ˆ<500å¼ ï¼‰ï¼šå‰3ä¸ªepochå…¨å±€ï¼Œä¹‹åæ©ç 
   - ä¸­æ•°æ®é›†ï¼ˆ500-5Kå¼ ï¼‰ï¼šå‰5ä¸ªepochå…¨å±€ï¼Œä¹‹åæ©ç  âœ… **æ¨è**
   - å¤§æ•°æ®é›†ï¼ˆ>5Kå¼ ï¼‰ï¼šå‰10ä¸ªepochå…¨å±€ï¼Œä¹‹åæ©ç 

2. **kernel_sizeé€‰æ‹©**ï¼š
   - 64Ã—64åˆ†è¾¨ç‡ï¼škernel_size=3 âœ… **æ¨è**
   - 128Ã—128åˆ†è¾¨ç‡ï¼škernel_size=5
   - 256Ã—256åˆ†è¾¨ç‡ï¼škernel_size=7

3. **ä¸å…¶ä»–æŠ€æœ¯ç»“åˆ**ï¼š
   - âœ… å¯ä»¥ä¸FGD/FSDlikeæŸå¤±ç»“åˆ
   - âœ… å¯ä»¥ä¸è¾¹ç¼˜å¢å¼ºï¼ˆedge_boostï¼‰åŒæ—¶å¯ç”¨
   - âœ… å¯ä»¥ä¸ç‰¹å¾è’¸é¦æŸå¤±å¹¶è¡Œä½¿ç”¨

## ğŸ”— ç›¸å…³æ–‡ä»¶

- æŸå¤±å‡½æ•°å®ç°ï¼š`vfmkd/distillation/losses/edge_loss.py`
- è®­ç»ƒè„šæœ¬ï¼š`tools/train_distill_single_test.py`
- å¯è§†åŒ–å·¥å…·ï¼š`tools/run_vis_only.py`

## ğŸ“š å‚è€ƒ

- **å½¢æ€å­¦è†¨èƒ€**ï¼šç”¨äºæ‰©å±•è¾¹ç¼˜åŒºåŸŸï¼Œæä¾›å¯¹é½å®¹é”™
- **Focal Lossæ€æƒ³**ï¼šå…³æ³¨éš¾æ ·æœ¬ï¼ˆè¾¹ç¼˜ï¼‰ï¼Œå¿½ç•¥ç®€å•æ ·æœ¬ï¼ˆå†…éƒ¨ï¼‰
- **æ¸è¿›å¼è®­ç»ƒ**ï¼šå…ˆç²—åç»†ï¼Œé€æ­¥èšç„¦å…³é”®åŒºåŸŸ

---

**Version**: 1.0  
**Date**: 2025-11-01  
**Author**: VFMKD Team

