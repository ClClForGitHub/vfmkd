# SimpleAdapter åŠ¨æ€åˆ›å»ºå’Œæƒé‡åŠ è½½éªŒè¯æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†å¯¹ `SimpleAdapter` çš„åŠ¨æ€åˆ›å»ºæœºåˆ¶å’Œæƒé‡åŠ è½½åŠŸèƒ½çš„éªŒè¯æµ‹è¯•ç»“æœã€‚

## âœ… æµ‹è¯•ç»“æœæ€»ç»“

æ‰€æœ‰æµ‹è¯•å‡å·²é€šè¿‡ï¼ŒéªŒè¯äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

### 1. åŠ¨æ€åˆ›å»ºæœºåˆ¶ âœ“
- **åŠŸèƒ½**ï¼šæ ¹æ®è¾“å…¥ç‰¹å¾çš„é€šé“æ•°åŠ¨æ€åˆ›å»ºé€‚é…å™¨
- **é”®æ ¼å¼**ï¼š`{student_channels}to{teacher_channels}`
- **æµ‹è¯•ç»“æœ**ï¼š
  - ç›¸åŒé€šé“ï¼ˆ256â†’256ï¼‰ï¼šä¸åˆ›å»ºé€‚é…å™¨ï¼Œç›´æ¥è¿”å›
  - ä¸åŒé€šé“ï¼ˆ128â†’256, 512â†’256, 256â†’512ï¼‰ï¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”é€‚é…å™¨
  - ä½¿ç”¨ `nn.ModuleDict` ç®¡ç†ï¼Œé¿å…é‡å¤åˆ›å»º

### 2. ç©ºé—´åˆ†è¾¨ç‡å¯¹é½ âœ“
- **åŠŸèƒ½**ï¼šä½¿ç”¨åŒçº¿æ€§æ’å€¼è‡ªåŠ¨å¯¹é½ç©ºé—´åˆ†è¾¨ç‡
- **æµ‹è¯•ç»“æœ**ï¼š
  - ç›¸åŒåˆ†è¾¨ç‡ï¼šæ— éœ€å¤„ç†
  - ä¸åŒåˆ†è¾¨ç‡ï¼šè‡ªåŠ¨ä¸Šé‡‡æ ·/ä¸‹é‡‡æ ·
  - æ”¯æŒéæ­£æ–¹å½¢åˆ†è¾¨ç‡ï¼ˆå¦‚ 128Ã—64 â†’ 64Ã—128ï¼‰

### 3. æƒé‡ä¿å­˜å’ŒåŠ è½½ âœ“
- **ä¿å­˜æ ¼å¼**ï¼š
  ```python
  {
      "adapters.{student_ch}to{teacher_ch}.adapter.weight": Tensor,
      ...
  }
  ```
- **åŠ è½½è¦æ±‚**ï¼š
  - âš ï¸ **é‡è¦**ï¼šåœ¨è°ƒç”¨ `load_state_dict()` ä¹‹å‰ï¼Œå¿…é¡»å…ˆè§¦å‘é€‚é…å™¨çš„åˆ›å»º
  - é€šè¿‡è°ƒç”¨ `adapter(student_feat, teacher_feat)` è§¦å‘åŠ¨æ€åˆ›å»º
  - ä½¿ç”¨ `strict=False` å…è®¸éƒ¨åˆ†åŠ è½½ï¼ˆæ–°é€šé“ç»„åˆä¼šåŠ¨æ€åˆ›å»ºï¼‰

### 4. å»¶è¿ŸåŠ è½½æœºåˆ¶ âœ“
- **åŠŸèƒ½**ï¼šåŠ è½½æƒé‡åï¼Œé‡åˆ°æ–°çš„é€šé“ç»„åˆä¼šè‡ªåŠ¨åˆ›å»ºæ–°é€‚é…å™¨
- **è¡Œä¸º**ï¼š
  - å·²å­˜åœ¨çš„é€‚é…å™¨ï¼šä»checkpointåŠ è½½æƒé‡
  - æ–°çš„é€šé“ç»„åˆï¼šåŠ¨æ€åˆ›å»ºï¼Œä½¿ç”¨éšæœºåˆå§‹åŒ–çš„æƒé‡

## ğŸ” å…³é”®å‘ç°

### åŠ¨æ€åˆ›å»ºçš„å·¥ä½œåŸç†

```python
# SimpleAdapter.forward()
if student_channels != teacher_channels:
    adapter_key = f"{student_channels}to{teacher_channels}"
    
    if adapter_key not in self.adapters:
        # åŠ¨æ€åˆ›å»ºæ–°é€‚é…å™¨
        adapter = ChannelAdapter(student_channels, teacher_channels)
        self.adapters[adapter_key] = adapter.to(student_features.device)
    
    student_features = self.adapters[adapter_key](student_features)
```

### æƒé‡ä¿å­˜æ ¼å¼

```python
# state_dict() è¾“å‡ºç¤ºä¾‹ï¼š
{
    "adapters.128to256.adapter.weight": Tensor([256, 128, 1, 1]),
    "adapters.512to256.adapter.weight": Tensor([256, 512, 1, 1]),
}
```

### æ­£ç¡®åŠ è½½æƒé‡çš„æ–¹æ³•

```python
# âœ… æ­£ç¡®æ–¹å¼ï¼šå…ˆè§¦å‘åˆ›å»ºï¼Œå†åŠ è½½æƒé‡
adapter = SimpleAdapter().to(device)

# æ–¹å¼1ï¼šé€šè¿‡å‰å‘ä¼ æ’­è§¦å‘åˆ›å»ºï¼ˆæ¨èï¼‰
student_feat = torch.randn(2, 128, 64, 64).to(device)
teacher_feat = torch.randn(2, 256, 64, 64).to(device)
_ = adapter(student_feat, teacher_feat)  # è§¦å‘åˆ›å»º

# æ–¹å¼2ï¼šä»checkpointåŠ è½½æƒé‡
checkpoint = torch.load("model.pth")
adapter.load_state_dict(checkpoint['feature_adapter'], strict=False)

# âŒ é”™è¯¯æ–¹å¼ï¼šç›´æ¥åŠ è½½ï¼ˆé€‚é…å™¨å°šæœªåˆ›å»ºï¼‰
adapter = SimpleAdapter().to(device)
adapter.load_state_dict(checkpoint['feature_adapter'])  # ä¼šå¤±è´¥æˆ–ä¸¢å¤±æƒé‡
```

## ğŸ“ è®­ç»ƒè„šæœ¬ä¸­çš„ä½¿ç”¨

### å½“å‰å®ç°ï¼ˆæ­£ç¡®ï¼‰

```python
# è®­ç»ƒè„šæœ¬ä¸­çš„ä½¿ç”¨
# 1. åˆå§‹åŒ–
self.feature_adapter = SimpleAdapter().to(self.device)

# 2. å‰å‘ä¼ æ’­ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºé€‚é…å™¨ï¼‰
aligned_features = self.feature_adapter(s16_features, teacher_features)

# 3. ä¿å­˜æƒé‡
torch.save({
    "feature_adapter": runner.feature_adapter.state_dict(),
    ...
}, "model.pth")

# 4. åŠ è½½æƒé‡ï¼ˆæ¢å¤è®­ç»ƒï¼‰
checkpoint = torch.load("model.pth")
# æ³¨æ„ï¼šåœ¨åŠ è½½å‰ï¼Œé€‚é…å™¨å·²ç»é€šè¿‡å‰å‘ä¼ æ’­åˆ›å»ºè¿‡äº†
runner.feature_adapter.load_state_dict(checkpoint['feature_adapter'])
```

### éªŒè¯æ£€æŸ¥ç‚¹

åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œç”±äºè®­ç»ƒè„šæœ¬ä¼šåœ¨å‰å‘ä¼ æ’­ä¸­è§¦å‘é€‚é…å™¨åˆ›å»ºï¼Œæ‰€ä»¥åœ¨æ¢å¤è®­ç»ƒæ—¶ï¼š

1. **æ­£å¸¸æƒ…å†µ**ï¼šé€‚é…å™¨å·²ç»é€šè¿‡å‰å‘ä¼ æ’­åˆ›å»ºï¼ŒåŠ è½½æƒé‡ä¼šæˆåŠŸ
2. **è¾¹ç•Œæƒ…å†µ**ï¼šå¦‚æœcheckpointä¸­æœ‰æ–°çš„é€šé“ç»„åˆï¼Œä¼šåœ¨ä¸‹ä¸€æ¬¡å‰å‘ä¼ æ’­æ—¶è‡ªåŠ¨åˆ›å»º

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åŠ è½½é¡ºåº**ï¼š
   - å¿…é¡»åœ¨è°ƒç”¨ `load_state_dict()` ä¹‹å‰è§¦å‘é€‚é…å™¨çš„åˆ›å»º
   - å¯é€šè¿‡å‰å‘ä¼ æ’­æˆ–æ‰‹åŠ¨åˆ›å»º

2. **strict å‚æ•°**ï¼š
   - ä½¿ç”¨ `strict=False` å…è®¸éƒ¨åˆ†åŠ è½½
   - æ–°çš„é€šé“ç»„åˆä¼šè‡ªåŠ¨åˆ›å»ºï¼Œä½¿ç”¨éšæœºåˆå§‹åŒ–

3. **è®¾å¤‡ä¸€è‡´æ€§**ï¼š
   - é€‚é…å™¨ä¼šè‡ªåŠ¨ç§»åŠ¨åˆ°è¾“å…¥ç‰¹å¾çš„è®¾å¤‡ä¸Š
   - åŠ è½½æƒé‡æ—¶éœ€ç¡®ä¿è®¾å¤‡ä¸€è‡´

4. **åˆ†è¾¨ç‡å¯¹é½**ï¼š
   - åˆ†è¾¨ç‡å¯¹é½ä½¿ç”¨åŒçº¿æ€§æ’å€¼ï¼Œæ— å‚æ•°
   - ä¸ä¼šå½±å“æƒé‡åŠ è½½

## ğŸ§ª æµ‹è¯•è„šæœ¬

è¿è¡Œå®Œæ•´æµ‹è¯•ï¼š
```bash
python tools/test_simple_adapter_dynamic.py
```

æµ‹è¯•å†…å®¹ï¼š
1. âœ… åŠ¨æ€åˆ›å»ºé€‚é…å™¨
2. âœ… ç©ºé—´åˆ†è¾¨ç‡å¯¹é½
3. âœ… æƒé‡ä¿å­˜å’ŒåŠ è½½
4. âœ… å»¶è¿ŸåŠ è½½æœºåˆ¶
5. âœ… Checkpointå…¼å®¹æ€§ï¼ˆå¦‚æœæœ‰å·²ä¿å­˜çš„checkpointï¼‰

## ğŸ“Š ç»“è®º

**SimpleAdapter å®Œå…¨æ”¯æŒåŠ¨æ€åˆ›å»ºå’Œæƒé‡åŠ è½½ï¼**

- âœ… åŠ¨æ€åˆ›å»ºæœºåˆ¶å·¥ä½œæ­£å¸¸
- âœ… æƒé‡ä¿å­˜æ ¼å¼æ­£ç¡®
- âœ… æƒé‡åŠ è½½åŠŸèƒ½æ­£å¸¸ï¼ˆéœ€å…ˆè§¦å‘åˆ›å»ºï¼‰
- âœ… åˆ†è¾¨ç‡å¯¹é½è‡ªåŠ¨å¤„ç†
- âœ… ä¸è®­ç»ƒè„šæœ¬å…¼å®¹

**å»ºè®®**ï¼šåœ¨è®­ç»ƒè„šæœ¬çš„æ¢å¤è®­ç»ƒéƒ¨åˆ†ï¼Œç¡®ä¿åœ¨åŠ è½½æƒé‡å‰å·²ç»è¿›è¡Œè¿‡ä¸€æ¬¡å‰å‘ä¼ æ’­ï¼Œæˆ–è€…ä½¿ç”¨ `strict=False` å…è®¸éƒ¨åˆ†åŠ è½½ï¼Œæ–°çš„é€‚é…å™¨ä¼šåœ¨ä¸‹ä¸€æ¬¡å‰å‘ä¼ æ’­æ—¶è‡ªåŠ¨åˆ›å»ºã€‚

---

**æµ‹è¯•æ—¥æœŸ**ï¼š2025-01-XX  
**æµ‹è¯•è„šæœ¬**ï¼š`tools/test_simple_adapter_dynamic.py`  
**éªŒè¯ç»“æœ**ï¼šâœ… å…¨éƒ¨é€šè¿‡
