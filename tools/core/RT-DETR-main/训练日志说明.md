# RT-DETRv2 è®­ç»ƒæ—¥å¿—è¯´æ˜

## ğŸ“‹ é—®é¢˜åŸå› 

**ä¸ºä»€ä¹ˆä¹‹å‰æ²¡æœ‰æ–‡æœ¬æ—¥å¿—ï¼Ÿ**

1. **è®­ç»ƒè„šæœ¬æœ¬èº«ä¸å†™æ—¥å¿—æ–‡ä»¶**ï¼š`tools/train.py` å’Œè®­ç»ƒå¼•æ“åªä½¿ç”¨ `print()` è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰ï¼Œä¸ä¼šè‡ªåŠ¨å†™å…¥æ–‡ä»¶ã€‚

2. **å¯åŠ¨è„šæœ¬éœ€è¦æ‰‹åŠ¨æŒ‡å®šè¾“å‡ºç›®å½•**ï¼šä¹‹å‰çš„ `run_rtdetrv2_train.sh` åªæœ‰åœ¨ä½¿ç”¨ `--output` å‚æ•°æ—¶æ‰ä¼šä¿å­˜æ—¥å¿—ã€‚

3. **ç›´æ¥è¿è¡Œå‘½ä»¤æ²¡æœ‰é‡å®šå‘**ï¼šå¦‚æœç›´æ¥ç”¨ `torchrun ... tools/train.py` è€Œä¸é‡å®šå‘ï¼Œè¾“å‡ºåªä¼šæ˜¾ç¤ºåœ¨ç»ˆç«¯ï¼Œå…³é—­ç»ˆç«¯åæ— æ³•æŸ¥çœ‹ã€‚

## âœ… ç°åœ¨çš„è§£å†³æ–¹æ¡ˆ

**å·²ä¿®æ”¹ `run_rtdetrv2_train.sh`ï¼Œç°åœ¨ä¼šï¼š**

1. **è‡ªåŠ¨ä»é…ç½®æ–‡ä»¶è¯»å– `output_dir`**ï¼šå¦‚æœ YAML é…ç½®ä¸­æœ‰ `output_dir: ./output/xxx`ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ã€‚
2. **è‡ªåŠ¨ç”Ÿæˆé»˜è®¤è¾“å‡ºç›®å½•**ï¼šå¦‚æœé…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰ `output_dir`ï¼Œä¼šæ ¹æ®é…ç½®æ–‡ä»¶åè‡ªåŠ¨ç”Ÿæˆï¼ˆå¦‚ `output/rtdetrv2_r50vd_6x_coco`ï¼‰ã€‚
3. **å§‹ç»ˆä¿å­˜æ—¥å¿—æ–‡ä»¶**ï¼šæ— è®ºæ˜¯å¦æŒ‡å®š `--output`ï¼Œéƒ½ä¼šå°†è®­ç»ƒæ—¥å¿—ä¿å­˜åˆ° `{OUTPUT_DIR}/train.log`ã€‚

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼Œè‡ªåŠ¨ä¿å­˜æ—¥å¿—ï¼‰

```bash
cd /home/team/zouzhiyuan/vfmkd/tools/core/RT-DETR-main
./run_rtdetrv2_train.sh \
  -c configs/rtdetrv2/rtdetrv2_r50vd_6x_coco.yml \
  -g "6,7" \
  -n 2 \
  -p 29545 \
  --total-batch 32 \
  --val-batch 64 \
  --extra --use-dog --seed 0
```

**æ—¥å¿—ä¼šè‡ªåŠ¨ä¿å­˜åˆ°ï¼š**
- `output/rtdetrv2_r50vd_6x_coco/train.log`ï¼ˆä»é…ç½®æ–‡ä»¶è¯»å–ï¼‰
- æˆ– `output/rtdetrv2_r50vd_6x_coco/train.log`ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰

### æ–¹æ³•2ï¼šç›´æ¥è¿è¡Œå‘½ä»¤ï¼ˆéœ€è¦æ‰‹åŠ¨é‡å®šå‘ï¼‰

```bash
cd /home/team/zouzhiyuan/vfmkd/tools/core/RT-DETR-main/RT-DETR-main/rtdetrv2_pytorch && \
CUDA_VISIBLE_DEVICES=6,7 torchrun --master_port=29545 --nproc_per_node=2 \
tools/train.py -c configs/rtdetrv2/rtdetrv2_r50vd_6x_coco.yml \
--use-amp --seed 0 --use-dog \
-u train_dataloader.total_batch_size=32 val_dataloader.total_batch_size=64 \
2>&1 | tee output/rtdetrv2_r50vd_6x_coco/train.log
```

### æ–¹æ³•3ï¼šä½¿ç”¨ screen/tmux + å¯åŠ¨è„šæœ¬ï¼ˆæ¨èç”¨äºé•¿æ—¶é—´è®­ç»ƒï¼‰

```bash
# å¯åŠ¨ screen ä¼šè¯
screen -S rtdetr_train

# è¿è¡Œè®­ç»ƒï¼ˆæ—¥å¿—ä¼šè‡ªåŠ¨ä¿å­˜ï¼‰
cd /home/team/zouzhiyuan/vfmkd/tools/core/RT-DETR-main
./run_rtdetrv2_train.sh -c configs/rtdetrv2/rtdetrv2_r50vd_6x_coco.yml --use-dog ...

# æŒ‰ Ctrl+A ç„¶å D æ¥ detachï¼ˆåå°è¿è¡Œï¼‰
# é‡æ–°è¿æ¥ï¼šscreen -r rtdetr_train
```

## ğŸ“Š å¦‚ä½•æ£€æŸ¥è®­ç»ƒè¿›åº¦

### 1. æŸ¥çœ‹æ–‡æœ¬æ—¥å¿—ï¼ˆå®æ—¶ï¼‰

```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f output/rtdetrv2_r50vd_6x_coco/train.log

# æŸ¥çœ‹æœ€å 100 è¡Œ
tail -n 100 output/rtdetrv2_r50vd_6x_coco/train.log

# æœç´¢ç‰¹å®šå†…å®¹ï¼ˆå¦‚ lossã€epochï¼‰
grep -E "Epoch|Loss|mAP" output/rtdetrv2_r50vd_6x_coco/train.log | tail -20
```

### 2. ä½¿ç”¨ TensorBoardï¼ˆå¯è§†åŒ–è®­ç»ƒæ›²çº¿ï¼‰

```bash
# å¯åŠ¨ TensorBoard
tensorboard --logdir output/rtdetrv2_r50vd_6x_coco/summary --port 6006

# ç„¶ååœ¨æµè§ˆå™¨æ‰“å¼€ï¼šhttp://localhost:6006
```

### 3. æ£€æŸ¥è®­ç»ƒçŠ¶æ€

```bash
# æŸ¥çœ‹è®­ç»ƒè¿›ç¨‹
ps aux | grep train.py | grep -v grep

# æŸ¥çœ‹ GPU ä½¿ç”¨æƒ…å†µ
nvidia-smi

# æŸ¥çœ‹æœ€æ–°çš„ checkpoint
ls -lht output/rtdetrv2_r50vd_6x_coco/checkpoints/ | head -5
```

## ğŸ“ æ—¥å¿—æ–‡ä»¶ä½ç½®

è®­ç»ƒæ—¥å¿—ä¼šä¿å­˜åœ¨ä»¥ä¸‹ä½ç½®ï¼š

```
output/rtdetrv2_r50vd_6x_coco/
â”œâ”€â”€ train.log              # è®­ç»ƒæ—¥å¿—ï¼ˆæ‰€æœ‰ print è¾“å‡ºï¼‰
â”œâ”€â”€ summary/               # TensorBoard æ—¥å¿—
â”‚   â””â”€â”€ events.out.tfevents.*
â””â”€â”€ checkpoints/           # æ¨¡å‹æ£€æŸ¥ç‚¹
    â”œâ”€â”€ checkpoint_*.pth
    â””â”€â”€ best_model.pth
```

## ğŸ” æ—¥å¿—å†…å®¹ç¤ºä¾‹

è®­ç»ƒæ—¥å¿—é€šå¸¸åŒ…å«ï¼š

- **é…ç½®ä¿¡æ¯**ï¼šæ¨¡å‹é…ç½®ã€æ•°æ®é›†è·¯å¾„ã€è®­ç»ƒå‚æ•°
- **è®­ç»ƒè¿›åº¦**ï¼šæ¯ä¸ª epoch çš„ lossã€å­¦ä¹ ç‡
- **éªŒè¯ç»“æœ**ï¼šmAPã€å„ç±»åˆ« AP
- **æ£€æŸ¥ç‚¹ä¿å­˜**ï¼šæ¨¡å‹ä¿å­˜ä½ç½®å’Œæ—¶æœº
- **é”™è¯¯ä¿¡æ¯**ï¼šå¦‚æœæœ‰ OOM æˆ–å…¶ä»–é”™è¯¯

ç¤ºä¾‹æ—¥å¿—ç‰‡æ®µï¼š
```
Epoch: [0]  [   0/1000]  eta: 0:10:23  lr: 0.000100  loss: 2.3456  loss_vfl: 1.2345  loss_bbox: 0.5678  loss_giou: 0.5433
Epoch: [0]  [  10/1000]  eta: 0:09:45  lr: 0.000100  loss: 1.9876  loss_vfl: 1.0123  loss_bbox: 0.4567  loss_giou: 0.5186
...
Epoch: [0]  [ 999/1000]  eta: 0:00:01  lr: 0.000100  loss: 1.2345  loss_vfl: 0.6789  loss_bbox: 0.3456  loss_giou: 0.2100
Validation: mAP@0.5:0.95 = 0.3456, mAP@0.5 = 0.5678
Checkpoint saved to: output/rtdetrv2_r50vd_6x_coco/checkpoints/checkpoint_epoch_0.pth
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ—¥å¿—æ–‡ä»¶ä¼šæŒç»­å¢é•¿**ï¼šé•¿æ—¶é—´è®­ç»ƒæ—¶ï¼Œæ—¥å¿—æ–‡ä»¶å¯èƒ½å¾ˆå¤§ï¼ˆå‡ ç™¾ MB åˆ°å‡  GBï¼‰ï¼Œå®šæœŸæ¸…ç†æˆ–ä½¿ç”¨ `logrotate`ã€‚

2. **å¤šè¿›ç¨‹è®­ç»ƒ**ï¼šä½¿ç”¨ `torchrun` å¤šå¡è®­ç»ƒæ—¶ï¼Œåªæœ‰ rank 0 ä¼šè¾“å‡ºæ—¥å¿—ï¼ˆé€šè¿‡ `print_rank=0` æ§åˆ¶ï¼‰ã€‚

3. **æ—¥å¿—å¤‡ä»½**ï¼šé‡è¦å®éªŒå»ºè®®å®šæœŸå¤‡ä»½æ—¥å¿—æ–‡ä»¶ï¼Œæ–¹ä¾¿åç»­åˆ†æã€‚

4. **å®æ—¶ç›‘æ§**ï¼šå»ºè®®ä½¿ç”¨ `tail -f` æˆ– TensorBoard å®æ—¶ç›‘æ§ï¼Œè€Œä¸æ˜¯ç­‰è®­ç»ƒç»“æŸåå†çœ‹æ—¥å¿—ã€‚

